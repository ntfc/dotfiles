#!/bin/sh

SLEEP=1
STALONETRAY_CFG="$HOME/.config/stalonetrayrc"
ICO_PATH="$HOME/.scripts/dzen2/icons/"

function tray_height() {
  # extract the icon_size of stalonetray (the first two numbers)
  TRAY_ICO_SIZE=$(egrep "^icon_size.*" $STALONETRAY_CFG | egrep -o '[0-9]{2}')
  echo $TRAY_ICO_SIZE
}

function dzen_width() {
  # extract the geometry width of stalonetray (the first 2 number).
  TRAY_GEOMETRY=$(egrep "^geometry.*" $STALONETRAY_CFG | egrep -o '[0-9]{2}')
  # extract the icon_size of stalonetray (the first two numbers)
  TRAY_ICO_SIZE=$(egrep "^icon_size.*" $STALONETRAY_CFG | egrep -o '[0-9]{2}')
  # the actual width of stalonetray is TRAY_GEOMETRY x TRAY_ICO_SIZE
  TRAY_WIDTH=$((TRAY_GEOMETRY*TRAY_ICO_SIZE))

  # get screen width
  SCREEN_WIDTH=`xrandr |  sed -ne 's/.*current \([^ ]*\).*/\1/p'`

  # dzen width = SCREEN_WIDTH - TRAY_WIDTH
  DZEN_WIDTH=$(($SCREEN_WIDTH-$TRAY_WIDTH))
  echo $DZEN_WIDTH
}

#############################################
# Dzen configuration/settings
#############################################
FONT="-*-terminus-medium-*-normal-*-13-*-*-*-*-*-*-*"
FG='#000000'
BG='#3b73bd'
HEIGHT=$(tray_height)
WIDTH=$(dzen_width)
POP_UP_WIDTH=200
ALIGN=r

DZEN="dzen2 -fn $FONT -fg $FG -bg $BG -dock -p -h $HEIGHT -tw $WIDTH -ta $ALIGN \
  -e 'leaveslave=collapse;entertitle=uncollapse,ungrabkeys;leavetitle=collapse;"

SEP="|"

# Infinite loop
while :; do
  CLOCK="^ca(1,gsimplecal)"`date +"%a %d %H:%M:%S"`"^ca()"

  BAT=$($HOME/.scripts/dzen2/battery)
  SOUND="^ca(1,pavucontrol)$($HOME/.scripts/dzen2/sound)^ca()"
  # sleep
  sleep $SLEEP
  # output
  echo "$SOUND $SEP $BAT $SEP $CLOCK $PADDING"

done | $DZEN

